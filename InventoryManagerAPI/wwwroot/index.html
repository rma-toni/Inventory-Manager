<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventory Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="mb-4">📦 Inventory Manager</h2>

        <div class="card card-body mb-4 shadow-sm">
            <h5>Add new product</h5>
            <div class="row g-2">
                <div class="col-md-2"><input type="number" id="inputId" class="form-control" placeholder="ID"></div>
                <div class="col-md-4"><input type="text" id="inputName" class="form-control" placeholder="Name"></div>
                <div class="col-md-2"><input type="number" id="inputPrice" class="form-control" placeholder="Price"></div>
                <div class="col-md-2"><input type="number" id="inputStock" class="form-control" placeholder="Stock"></div>
                <div class="col-md-2"><button id="main-btn" onclick="execAction()" class="btn btn-success w-100">Save</button></div>
            </div>
        </div>

        <table class="table table-hover bg-white shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="body-table"></tbody>
        </table>
    </div>

    <script>
        let editing = false;
        
        const API_URL = '/api/inventory';

        async function loadProducts() {
            const res = await fetch(API_URL);
            const products = await res.json();
            const body = document.getElementById('body-table');

            body.innerHTML = products.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>$${p.price}</td>
                        <td>${p.stockQuantity}</td>
                        <td>
                            <button onclick="del(${p.id})" class="btn btn-outline-danger btn-sm">Delete</button>
                            <button onclick="prepModify(${p.id}, '${p.name}', ${p.price}, ${p.stockQuantity})" class="btn btn-outline-warning btn-sm">Modify</button>
                        </td>
                    </tr>
                `).join('');
        }

        async function add() {
            const newP = {
                id: parseInt(document.getElementById('inputId').value),
                name: document.getElementById('inputName').value,
                price: parseFloat(document.getElementById('inputPrice').value),
                stockQuantity: parseInt(document.getElementById('inputStock').value)
            };

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newP)
            });

            if (res.ok) {
                loadProducts();
                document.querySelectorAll('input').forEach(i => i.value = '');
            } else {
                const err = await res.json();
                alert("Error: " + (err.title || "Wrong data"));
            }
        }

        async function del(id) {
            if (confirm('Do you want to remove this product?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                loadProducts();
            }
        }

        function prepModify(id, name, price, stock) {
            document.getElementById('inputId').value = id;
            document.getElementById('inputName').value = name;
            document.getElementById('inputPrice').value = price;
            document.getElementById('inputStock').value = stock;

            editing = true;
            document.getElementById('inputId').readOnly = true; // El ID no se toca al editar

            // TRANSFORMAMOS EL BOTÓN
            const btn = document.getElementById('main-btn');
            btn.innerText = "Actualizar Cambios";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
        }

        // 2. Esta es la función que llama el botón ahora
        async function execAction() {
            if (editing) {
                await update(); // Si el estado es editando, llama a actualizar
            } else {
                await add();    // Si no, llama a guardar nuevo
            }
            resetearFormulario();
        }

        // 3. Limpiamos todo para volver al estado inicial
        function resetearFormulario() {
            editing = false;
            document.getElementById('inputId').readOnly = false;
            document.querySelectorAll('input').forEach(i => i.value = '');

            // Restauramos el botón a su forma original
            const btn = document.getElementById('main-btn');
            btn.innerText = "Save";
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');
        }

        async function update() {
            const id = document.getElementById('inputId').value;

            const editedProduct = {
                id: parseInt(id),
                name: document.getElementById('inputName').value,
                price: parseFloat(document.getElementById('inputPrice').value),
                stockQuantity: parseInt(document.getElementById('inputStock').value)
            };

            const res = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editedProduct)
            });

            if (res.ok) {
                alert("Product updated successfully");
                document.getElementById('inputId').readOnly = false; // Desbloqueamos el ID
                document.querySelectorAll('input').forEach(i => i.value = ''); // Limpiamos
                loadProducts(); // Refrescamos tabla
            } else {
                alert("Error updating product");
            }
        }

        loadProducts();
    </script>
</body>
</html>